name: "onPush( Build & Test )"

on:
  push:
    ignore-branches: [ "master" ]

jobs:
  build-and-test:
    name: "Test on ï£¿ iOS Simulator (xcode: 14.2.0, macos: latest)"
    runs-on: 'macos-latest'
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - uses: maxim-lobanov/setup-xcode@v1.2.3
        with:
          xcode-version: '14.2.0'
      - name: Clone Mock Server
        uses: actions/checkout@v3
        with:
          repository: frontegg/frontegg-mock-server
          ssh-key: ${{ secrets.MOCK_SERVER_SSH_KEY }}
          ref: "master"
          path: mocker
      - name: Run Mock Server
        working-directory: mocker
        run: |
          yarn install
          cd packages/mobile-mocker
          (yarn start&)
      - name: Run HostedLogin Server
        working-directory: mocker
        run: (yarn start:hosted-login&)
      - name: Double-check macOS version (macos-latest)
        run: sw_vers
      - name: Double-check Xcode.app selected
        run: xcode-select --print-path
      - name: Check xcodebuild version
        run: xcodebuild -project demo/demo.xcodeproj -version
      - name: Check xcode embedded SDKs
        run: xcodebuild -project demo/demo.xcodeproj -showsdks
      - name: Show buildable schemes
        run: xcodebuild -project demo/demo.xcodeproj -list
      - name: Show eligible build destinations for the "demo"
        run: xcodebuild -project demo/demo.xcodeproj -showdestinations -scheme "demo"
      - name: Build for Testing
        run: xcodebuild CC=clang CPLUSPLUS=clang++ -derivedDataPath demo/build LD=clang LDPLUSPLUS=clang++ build-for-testing -scheme "demo" -project "demo/demo.xcodeproj" -destination "platform=iOS Simulator,name=iPhone 14 Pro" -configuration "Debug" -enableCodeCoverage "YES"
      - name: Test without Building
        run: xcodebuild CC=clang CPLUSPLUS=clang++ -derivedDataPath demo/build LD=clang LDPLUSPLUS=clang++ test-without-building -scheme "demo" -project "demo/demo.xcodeproj" -destination "platform=iOS Simulator,name=iPhone 14 Pro" -configuration "Debug" -resultBundlePath "TestResults" -enableCodeCoverage "YES"
      - name: "Print XCResult Status"
        uses: kishikawakatsumi/xcresulttool@v1
        if: success() || failure()
        with:
          path: TestResults.xcresult
      - name: "Upload test results"
        if: success() || failure()
        uses: actions/upload-artifact@v3
        with:
          name: 'TestResults.xcresult'
          path: TestResults.xcresult
